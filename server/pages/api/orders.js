"use strict";(()=>{var e={};e.id=722,e.ids=[722],e.modules={1185:e=>{e.exports=require("mongoose")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6090:e=>{e.exports=import("stripe")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},1996:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{config:()=>c,default:()=>u,routeModule:()=>p});var i=r(1802),o=r(7153),a=r(6249),s=r(9682),d=e([s]);s=(d.then?(await d)():d)[0];let u=(0,a.l)(s,"default"),c=(0,a.l)(s,"config"),p=new i.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/orders",pathname:"/api/orders",bundlePath:"",filename:""},userland:s});n()}catch(e){n(e)}})},3275:(e,t,r)=>{r.d(t,{I:()=>o});var n=r(1185),i=r.n(n);function o(){if(process.env.MONGODB_URI,1===i().connection.readyState)return i().connection.asPromise();{let e=process.env.MONGODB_URI;return i().connect(e)}}},9872:(e,t,r)=>{r.d(t,{Z:()=>a});var n=r(1185),i=r.n(n);let o=new n.Schema({firstname:{type:String,required:!0},name:{type:String,required:!0},ville:{type:String,required:!0},codePost:{type:String,required:!0},adresse:{type:String,required:!0},pays:{type:String,required:!0},products:[{type:String,required:!0}]},{timestamps:!0}),a=i().models.Order||i().model("Order",o)},2602:(e,t,r)=>{r.d(t,{b:()=>a});var n=r(1185),i=r.n(n);let o=new n.Schema({title:{type:String,required:!0},price:{type:Number,required:!0},description:{type:String,required:!0},categorie:{type:i().Types.ObjectId,ref:"Categorie",required:!0},products:[{type:i().Schema.Types.ObjectId,ref:"Product",required:!0}]},{timestamps:!0}),a=n.models.Produit||(0,n.model)("Produit",o)},9682:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{default:()=>u});var i=r(3275),o=r(9872),a=r(6090),s=r(2602),d=e([a]);let c=new(a=(d.then?(await d)():d)[0]).default(process.env.STRIPE_SK);async function u(e,t){if("POST"===e.method)try{await (0,i.I)();let{firstname:r,name:n,ville:a,codePost:d,adresse:u,pays:p,products:l}=e.body;console.log("Request body:",e.body);let m=[...new Set(l)],y=await s.b.find({_id:{$in:m}}),f=[];for(let e of m){let t=y.find(t=>t._id.toString()===e),r=l.filter(t=>t===e).length;r>0&&t&&f.push({price_data:{currency:"usd",product_data:{name:t.title},unit_amount:100*t.price},quantity:r})}let P=new o.Z({firstname:r,name:n,ville:a,codePost:d,adresse:u,pays:p,products:m});await P.save();let g=await c.checkout.sessions.create({payment_method_types:["card"],line_items:f,mode:"payment",success_url:`${e.headers.origin}/success`,cancel_url:`${e.headers.origin}/cancel`});t.status(201).json({url:g.url})}catch(e){console.error("Error creating Stripe session:",e),t.status(500).json({error:"Error creating order",details:e.message})}else t.status(405).json({error:"Method Not Allowed"})}n()}catch(e){n(e)}})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=1996);module.exports=r})();